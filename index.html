<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Список песен</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background:
                radial-gradient(max(1200px, 60vmax) max(800px, 40vmax) at 10% 0vh, rgba(230, 57, 70, 0.18), transparent 66%),
                radial-gradient(max(1000px, 65vmax) max(700px, 40vmax) at 50% 0vh, rgba(230, 57, 70, 0.14), transparent 65%),
                radial-gradient(max(900px, 50vmax) max(700px, 35vmax) at 90% 0vh, rgba(181, 61, 70, 0.18), transparent 64%),
                linear-gradient(180deg, #0f0f10 0%, #151515 40%, #1a1a1a 100%);
            background-attachment: fixed, fixed, fixed, fixed;
            background-blend-mode: screen, screen, screen, normal;
            color: #e8e8e8;
        }
        
        .text-gradient-red {
            background-image: linear-gradient(to right, #e63946, #b53d46);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        canvas#bgParticles {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        body > *:not(canvas#bgParticles):not(.absolute) {
            position: relative;
            z-index: 1;
        }

        #songList, #chordstabsList { counter-reset: list-counter; }
        .song-list-item { counter-increment: list-counter; transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
        .song-list-item:hover { transform: translateY(-2px); border-color: rgba(230,57,70,.5); box-shadow: 0 10px 35px rgba(230,57,70,.18); }
        .song-list-item::before {
            content: counter(list-counter);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            margin-right: 1rem;
            border-radius: 9999px;
            background-image: linear-gradient(135deg, #e63946, #b53d46);
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(230,57,70,.35);
            flex: 0 0 2.25rem;
        }

        .active-lang { background-image: linear-gradient(135deg, #e63946, #b53d46); box-shadow: 0 10px 30px rgba(230,57,70,.35); }

        .active-tab { color: #fff; }

        #langMenu { opacity: 0; transform: translateY(-8px); pointer-events: none; transition: opacity .15s ease, transform .15s ease; }
        #langMenu.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #lang-toggle { width: 2.75rem; height: 2.75rem; }

        .tablist { position: relative; overflow: hidden; border-radius: 0.75rem; }
        #tabIndicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-image: linear-gradient(135deg, #e63946, #b53d46);
            border-radius: 0.5rem;
            box-shadow: 0 10px 30px rgba(230,57,70,.35);
            transition: transform .25s ease, width .25s ease, height .25s ease;
            will-change: transform, width, height;
            z-index: 0;
            pointer-events: none;
        }
        .tab-button { position: relative; z-index: 1; }

        .fade-in { animation: fadeInUp .28s ease both; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        main { overflow-anchor: none; }

        @keyframes listExitUp { to { opacity: 0; transform: translateY(-8px); } }
        @keyframes listExitDown { to { opacity: 0; transform: translateY(8px); } }
        @keyframes listEnterUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes listEnterDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .list-exit-up { animation: listExitUp .18s ease both; }
        .list-exit-down { animation: listExitDown .18s ease both; }
        .list-enter-up { animation: listEnterUp .22s ease both; }
        .list-enter-down { animation: listEnterDown .22s ease both; }

        @media (max-width: 480px) {
            body {
                padding-top: calc(4rem + constant(safe-area-inset-top));
                padding-top: calc(4rem + env(safe-area-inset-top));
                background:
                    radial-gradient(max(1200px, 60vmax) max(800px, 40vmax) at 10% 0vh, rgba(230, 57, 70, 0.06), transparent 82%),
                    radial-gradient(max(1000px, 65vmax) max(700px, 40vmax) at 50% 0vh, rgba(230, 57, 70, 0.05), transparent 80%),
                    radial-gradient(max(900px, 50vmax) max(700px, 35vmax) at 90% 0vh, rgba(181, 61, 70, 0.06), transparent 79%),
                    linear-gradient(180deg, #0f0f10 0%, #151515 40%, #1a1a1a 100%);
                background-attachment: scroll, scroll, scroll, scroll;
                background-blend-mode: normal, normal, normal, normal;
            }
            .song-list-item { padding: 0.875rem; }
            .song-list-item::before { width: 2rem; height: 2rem; font-size: .9rem; }
        }
    </style>
</head>
<body class="p-6 md:p-12 pt-24 md:pt-32 flex flex-col items-center justify-center min-h-screen">
    <canvas id="bgParticles" aria-hidden="true"></canvas>

    <div class="absolute top-4 right-4 z-50">
        <div class="relative">
            <button id="lang-toggle" class="flex items-center justify-center rounded-full bg-gray-800 text-white shadow-lg ring-1 ring-white/10 hover:bg-gray-700 transition focus:outline-none focus:ring-2 focus:ring-red-500" aria-haspopup="true" aria-expanded="false" aria-controls="langMenu" title="Выбрать язык">
                <img src="img/Language.png" alt="Язык" class="w-6 h-6" width="24" height="24" />
            </button>
            <div id="langMenu" class="absolute right-0 mt-2 w-44 bg-gray-800/95 backdrop-blur rounded-xl shadow-xl border border-white/10 p-2 origin-top-right z-50">
                <button id="lang-ru" class="w-full text-left px-3 py-3 rounded-lg text-white hover:bg-gray-700 transition">Русский</button>
                <button id="lang-uk" class="w-full text-left px-3 py-3 rounded-lg text-white hover:bg-gray-700 transition">Українська</button>
                <button id="lang-en" class="w-full text-left px-3 py-3 rounded-lg text-white hover:bg-gray-700 transition">English</button>
            </div>
        </div>
    </div>

    <header class="text-center mb-12">
        <h1 id="mainTitle" class="text-4xl md:text-5xl font-bold text-gradient-red mb-2"></h1>
        <p id="mainDescription" class="text-lg text-gray-400 max-w-2xl mx-auto"></p>
        <p class="text-lg text-white mt-4">
            <a href="https://www.tiktok.com/@apostrof_guitarist" target="_blank" class="hover:underline text-gradient-red">@apostrof_guitarist</a>
        </p>
    </header>

    <main class="w-full max-w-2xl">
        <div class="mb-5 md:mb-6">
            <label for="searchInput" class="sr-only">Поиск</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
                    <img src="img/Search.png" alt="Поиск" class="w-5 h-5" width="20" height="20" />
                </span>
                <input id="searchInput" type="text" inputmode="search" class="w-full pl-10 pr-10 py-3 md:py-3.5 rounded-xl bg-gray-900/60 text-white placeholder-gray-500 ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-red-500 shadow-[0_8px_30px_rgba(0,0,0,0.12)]" placeholder="" autocomplete="off" />
                <button id="clearSearch" type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white transition hidden" title="Очистить">
                    ✕
                </button>
            </div>
        </div>
        <div id="tabsContainer" class="tablist mb-6 inline-flex gap-1 md:gap-2 rounded-xl bg-gray-900/60 p-1 ring-1 ring-white/10" role="tablist" aria-label="Song tabs">
            <div id="tabIndicator" aria-hidden="true"></div>
            <button id="tab-all" class="tab-button px-4 py-2 rounded-lg text-sm md:text-base text-white/90 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40" role="tab" aria-selected="true">Все песни</button>
            <button id="tab-chordstabs" class="tab-button px-4 py-2 rounded-lg text-sm md:text-base text-white/90 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40" role="tab" aria-selected="false">Мои подборы</button>
        </div>
        <section id="allSection">
            <ol id="songList" class="list-none p-0 space-y-4"></ol>
            <div id="songPagination" class="mt-4 flex items-center justify-center gap-2"></div>
        </section>
        <section id="chordstabsSection" class="hidden relative">
            <h2 id="chordstabsHeader" class="text-2xl font-semibold mb-4 text-gradient-red flex items-center gap-2">
                <span id="chordstabsHeaderText"></span>
                <a href="https://mychords.net" target="_blank" rel="noopener noreferrer" class="inline-flex items-center">
                    <img src="img/mychords-logo.png" alt="mychords" class="h-6 md:h-7 w-auto" />
                </a>
            </h2>
            <ol id="chordstabsList" class="list-none p-0 space-y-4 relative"></ol>
            <div id="chordstabsPagination" class="mt-4 flex items-center justify-center gap-2"></div>
        </section>
    </main>

    <script>
        // by apostrof_guitarist
        document.addEventListener('DOMContentLoaded', () => {
            const translations = {
                'ru': {
                    pageTitle: 'Список песен',
                    mainTitle: 'Мой репертуар',
                    mainDescription: 'Привет! Выбирайте песню по номеру из списка ниже.',
                    songsNotFound: 'Список песен не найден.',
                    songsEmpty: 'Список песен пуст.',
                    tabAll: 'Все песни',
                    tabChordstabs: 'Мои подборы',
                    chordstabsHeader: 'Мои подборы на',
                    chordstabsNotFound: 'Список подборов не найден.',
                    chordstabsEmpty: 'Список подборов пуст.',
                    searchPlaceholder: 'Поиск по названию или исполнителю...',
                    noResults: 'Ничего не найдено.'
                },
                'uk': {
                    pageTitle: 'Список пісень',
                    mainTitle: 'Мій репертуар',
                    mainDescription: 'Привіт! Обирайте пісню за номером зі списку нижче.',
                    songsNotFound: 'Список пісень не знайдено.',
                    songsEmpty: 'Список пісень порожній.',
                    tabAll: 'Всі пісні',
                    tabChordstabs: 'Мої акорди/таби',
                    chordstabsHeader: 'Мої акорди/таби на',
                    chordstabsNotFound: 'Список підборів не знайдено.',
                    chordstabsEmpty: 'Список підборів порожній.',
                    searchPlaceholder: 'Пошук за назвою або виконавцем...',
                    noResults: 'Нічого не знайдено.'
                },
                'en': {
                    pageTitle: 'Song List',
                    mainTitle: 'My Repertoire',
                    mainDescription: 'Hey! Choose a song by number from the list below.',
                    songsNotFound: 'Song list not found.',
                    songsEmpty: 'Song list is empty.',
                    tabAll: 'All songs',
                    tabChordstabs: 'My chordstabs',
                    chordstabsHeader: 'My chordstabs on',
                    chordstabsNotFound: 'Chordstabs list not found.',
                    chordstabsEmpty: 'Chordstabs list is empty.',
                    searchPlaceholder: 'Search by title or artist...',
                    noResults: 'No results.'
                }
            };

            const listElement = document.getElementById('songList');
            const chordstabsList = document.getElementById('chordstabsList');
            const songPagination = document.getElementById('songPagination');
            const chordstabsPagination = document.getElementById('chordstabsPagination');
            const allSection = document.getElementById('allSection');
            const chordstabsSection = document.getElementById('chordstabsSection');
            const tabAll = document.getElementById('tab-all');
            const tabChordstabsBtn = document.getElementById('tab-chordstabs');
            const tabsContainer = document.getElementById('tabsContainer');
            const tabIndicator = document.getElementById('tabIndicator');
            const chordstabsHeaderEl = document.getElementById('chordstabsHeader');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');

            let lastTextContent = null;
            let currentTab = (() => { try {
                const t = localStorage.getItem('tab');
                return (t === 'all' || t === 'chordstabs') ? t : 'all';
            } catch(e) { return 'all'; } })();
            let searchQuery = (() => { try { return localStorage.getItem('searchQuery') || ''; } catch(e) { return ''; } })();
            let songsCache = null; 
            let chordstabsCache = null;
            let songsSortedCache = null;
            let chordstabsSortedCache = null;
            let songsPage = 1;
            let chordstabsPage = 1;
            const pageSize = 35;
            let lastSongsPage = 1;
            let lastChordstabsPage = 1;
            let skipNextListAnimation = false;

            function animateListTransition(listEl, direction) {
                if (!listEl) return Promise.resolve();
                return new Promise((resolve) => {
                    const exitClass = direction === 'forward' ? 'list-exit-up' : 'list-exit-down';
                    const enterClass = direction === 'forward' ? 'list-enter-up' : 'list-enter-down';
                    listEl.classList.remove('list-enter-up','list-enter-down','list-exit-up','list-exit-down');
                    listEl.classList.add(exitClass);
                    const onEnd = () => {
                        listEl.removeEventListener('animationend', onEnd);
                        listEl.classList.remove(exitClass);
                        resolve(enterClass);
                    };
                    listEl.addEventListener('animationend', onEnd, { once: true });
                });
            }

            function buildPagination(totalItems, currentPage, onPageChange, container) {
                if (!container) return;
                container.innerHTML = '';
                const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
                if (totalPages <= 1) return;

                const btn = (label, page, disabled = false, active = false) => {
                    const b = document.createElement('button');
                    b.textContent = label;
                    b.className = `px-3 py-2 rounded-lg ring-1 ring-white/10 bg-gray-900/60 text-white/80 hover:text-white hover:bg-gray-800 ${disabled ? 'opacity-50 cursor-default' : ''} ${active ? 'ring-2 ring-red-500 text-white' : ''}`;
                    if (!disabled && !active) b.addEventListener('click', () => {
                        onPageChange(page);
                        try {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        } catch (e) {
                            window.scrollTo(0, 0);
                        }
                    });
                    return b;
                };

                container.appendChild(btn('‹', Math.max(1, currentPage - 1), currentPage === 1));

                const windowSize = 5;
                const half = Math.floor(windowSize / 2);
                let start = Math.max(1, currentPage - half);
                let end = Math.min(totalPages, start + windowSize - 1);
                start = Math.max(1, Math.min(start, end - windowSize + 1));

                for (let p = start; p <= end; p++) {
                    container.appendChild(btn(String(p), p, false, p === currentPage));
                }

                container.appendChild(btn('›', Math.min(totalPages, currentPage + 1), currentPage === totalPages));
            }

            function normalizeString(value) {
                try {
                    return String(value || '')
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/\p{Diacritic}/gu, '');
                } catch (e) {
                    return String(value || '').toLowerCase();
                }
            }

            function moveIndicatorTo(element) {
                if (!tabsContainer || !tabIndicator || !element) return;
                const containerRect = tabsContainer.getBoundingClientRect();
                const elRect = element.getBoundingClientRect();
                const offsetLeft = elRect.left - containerRect.left;
                const offsetTop = elRect.top - containerRect.top;
                tabIndicator.style.transform = `translate(${offsetLeft}px, ${offsetTop}px)`;
                tabIndicator.style.width = `${elRect.width}px`;
                tabIndicator.style.height = `${elRect.height}px`;
                tabIndicator.style.borderRadius = window.getComputedStyle(element).borderRadius || '0.5rem';
            }

            function setActiveTab(tab) {
                const prevScrollY = window.scrollY || window.pageYOffset || 0;
                currentTab = tab;
                try { localStorage.setItem('tab', tab); } catch (e) {}
                if (tab === 'all') {
                    skipNextListAnimation = true;
                    songsPage = 1; lastSongsPage = 1;
                    tabAll?.classList.add('active-tab');
                    tabChordstabsBtn?.classList.remove('active-tab');
                    allSection?.classList.remove('hidden');
                    chordstabsSection?.classList.add('hidden');
                    if (allSection) {
                        allSection.classList.remove('fade-in');
                        void allSection.offsetWidth;
                        allSection.classList.add('fade-in');
                    }
                    moveIndicatorTo(tabAll);
                } else if (tab === 'chordstabs') {
                    skipNextListAnimation = true;
                    chordstabsPage = 1; lastChordstabsPage = 1;
                    tabChordstabsBtn?.classList.add('active-tab');
                    tabAll?.classList.remove('active-tab');
                    chordstabsSection?.classList.remove('hidden');
                    allSection?.classList.add('hidden');
                    if (chordstabsSection) {
                        chordstabsSection.classList.remove('fade-in');
                        void chordstabsSection.offsetWidth;
                        chordstabsSection.classList.add('fade-in');
                    }
                    moveIndicatorTo(tabChordstabsBtn);
                }
                if (lastTextContent) {
                    renderCurrentTab(lastTextContent);
                }
				
                window.scrollTo(0, prevScrollY);
            }

            async function renderAllSongs(textContent) {
                let songs = songsSortedCache;
                if (!Array.isArray(songs)) {
                    songs = [];
                    try {
                        const response = await fetch('data/songs.txt');
                        if (!response.ok) {
                            throw new Error(`Failed to load songs.txt: ${response.statusText}`);
                        }
                        const text = await response.text();
                        const parsed = text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                const parts = line.split(' - ');
                                if (parts.length >= 2) {
                                    return {
                                        artist: parts[0].trim(),
                                        title: parts.slice(1).join(' - ').trim()
                                    };
                                }
                                return null;
                            })
                            .filter(song => song !== null);
                        const withKeys = parsed.map((s, idx) => ({ ...s, __originalIndex: idx }));
                        withKeys.sort((a, b) => {
                            const aa = normalizeString(a.artist);
                            const bb = normalizeString(b.artist);
                            if (aa !== bb) return aa.localeCompare(bb);
                            const at = normalizeString(a.title);
                            const bt = normalizeString(b.title);
                            return at.localeCompare(bt);
                        });
                        songsCache = parsed;
                        songsSortedCache = withKeys;
                        songs = withKeys;
                    } catch (error) {
                        console.error('Ошибка загрузки songs.txt. Убедитесь, что файл существует на сервере.', error);
                        listElement.innerHTML = `<li class="text-red-500 text-center">${textContent.songsNotFound}</li>`;
                        return;
                    }
                }

                const query = normalizeString(searchQuery);
                const filtered = query
                    ? songs.filter(s => {
                        const hay = normalizeString(`${s.title} ${s.artist}`);
                        return hay.includes(query);
                    })
                    : songs;

                if (songs.length === 0) {
                    listElement.innerHTML = `<li class="text-red-500 text-center">${textContent.songsEmpty}</li>`;
                    return;
                }

                if (filtered.length === 0) {
                    listElement.innerHTML = `<li class="text-gray-400 text-center">${textContent.noResults}</li>`;
                    return;
                }

                if (query) {
                    listElement.style.counterReset = 'list-counter 0';
                    listElement.innerHTML = '';
                    filtered.forEach(song => {
                        const originalIndex = (typeof song.__originalIndex === 'number') ? song.__originalIndex : songsCache.indexOf(song);
                        const listItem = document.createElement('li');
                        listItem.className = 'bg-gray-800/70 backdrop-blur rounded-2xl p-4 md:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white/10 flex items-center song-list-item';
                        if (originalIndex >= 0) listItem.style.counterReset = `list-counter ${originalIndex}`;
                        listItem.innerHTML = `
                            <span class="text-xl text-white font-semibold flex-1">
                                ${song.title} - <span class="text-gray-400 font-normal">${song.artist}</span>
                            </span>
                        `;
                        listElement.appendChild(listItem);
                    });
                    if (songPagination) songPagination.classList.add('hidden');
                    return;
                }

                const total = filtered.length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                songsPage = Math.min(Math.max(1, songsPage), totalPages);
                const direction = songsPage > lastSongsPage ? 'forward' : 'backward';
                lastSongsPage = songsPage;
                const startIdx = (songsPage - 1) * pageSize;
                const endIdx = Math.min(total, startIdx + pageSize);
                const pageItems = filtered.slice(startIdx, endIdx);
                const enterClass = skipNextListAnimation ? null : await animateListTransition(listElement, direction);
                listElement.innerHTML = '';
                listElement.style.counterReset = `list-counter ${startIdx}`;

                pageItems.forEach(song => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-800/70 backdrop-blur rounded-2xl p-4 md:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white/10 flex items-center song-list-item';
                    listItem.innerHTML = `
                        <span class="text-xl text-white font-semibold flex-1">
                            ${song.title} - <span class="text-gray-400 font-normal">${song.artist}</span>
                        </span>
                    `;
                    listElement.appendChild(listItem);
                });
                if (enterClass) {
                    listElement.classList.add(enterClass);
                    requestAnimationFrame(() => {
                        listElement.classList.remove(enterClass);
                    });
                }
                skipNextListAnimation = false;

                if (songPagination) songPagination.classList.remove('hidden');
                buildPagination(total, songsPage, (p) => { songsPage = p; renderAllSongs(textContent); }, songPagination);
            }

            async function renderChordstabs(textContent) {
                if (!chordstabsList) return;
                let chordstabsItems = chordstabsSortedCache;
                if (!Array.isArray(chordstabsItems)) {
                    chordstabsItems = [];
                    try {
                        const response = await fetch('data/mychords.txt');
                        if (!response.ok) {
                            throw new Error(`Failed to load mychords.txt: ${response.statusText}`);
                        }
                        const text = await response.text();
                        const parsed = text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                const m = line.match(/^\s*(.+?)\s*-\s*(.+?)\s*\[(.+?)\]\s*$/);
                                if (m) {
                                    return { artist: m[1].trim(), title: m[2].trim(), url: m[3].trim() };
                                }
                                return null;
                            })
                            .filter(item => item !== null);
                        const withKeys = parsed.map((s, idx) => ({ ...s, __originalIndex: idx }));
                        withKeys.sort((a, b) => {
                            const aa = normalizeString(a.artist);
                            const bb = normalizeString(b.artist);
                            if (aa !== bb) return aa.localeCompare(bb);
                            const at = normalizeString(a.title);
                            const bt = normalizeString(b.title);
                            return at.localeCompare(bt);
                        });
                        chordstabsCache = parsed;
                        chordstabsSortedCache = withKeys;
                        chordstabsItems = withKeys;
                    } catch (error) {
                        console.error('Ошибка загрузки mychords.txt. Убедитесь, что файл существует на сервере.', error);
                        chordstabsList.innerHTML = `<li class=\"text-red-500 text-center\">${textContent.chordstabsNotFound}</li>`;
                        return;
                    }
                }

                const query = normalizeString(searchQuery);
                const filtered = query
                    ? chordstabsItems.filter(p => {
                        const hay = normalizeString(`${p.title} ${p.artist}`);
                        return hay.includes(query);
                    })
                    : chordstabsItems;

                chordstabsList.innerHTML = '';
                if (chordstabsItems.length === 0) {
                    chordstabsList.innerHTML = `<li class=\"text-red-500 text-center\">${textContent.chordstabsEmpty}</li>`;
                    return;
                }

                if (filtered.length === 0) {
                    chordstabsList.innerHTML = `<li class="text-gray-400 text-center">${textContent.noResults}</li>`;
                    return;
                }

                if (query) {
                    chordstabsList.style.counterReset = 'list-counter 0';
                    filtered.forEach(p => {
                        const originalIndex = (typeof p.__originalIndex === 'number') ? p.__originalIndex : chordstabsCache.indexOf(p);
                        const listItem = document.createElement('li');
                        listItem.className = 'bg-gray-800/70 backdrop-blur rounded-2xl p-4 md:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white/10 flex items-center song-list-item';
                        if (originalIndex >= 0) listItem.style.counterReset = `list-counter ${originalIndex}`;
                        listItem.innerHTML = `
                            <a href="${p.url}" target="_blank" rel="noopener noreferrer" class="flex items-center w-full">
                                <span class="text-xl text-white font-semibold flex-1">
                                    ${p.title} - <span class="text-gray-400 font-normal">${p.artist}</span>
                                </span>
                            </a>
                        `;
                        chordstabsList.appendChild(listItem);
                    });
                    if (chordstabsPagination) chordstabsPagination.classList.add('hidden');
                    return;
                }

                const total = filtered.length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                chordstabsPage = Math.min(Math.max(1, chordstabsPage), totalPages);
                const direction = chordstabsPage > lastChordstabsPage ? 'forward' : 'backward';
                lastChordstabsPage = chordstabsPage;
                const startIdx = (chordstabsPage - 1) * pageSize;
                const endIdx = Math.min(total, startIdx + pageSize);
                const pageItems = filtered.slice(startIdx, endIdx);
                const enterClass = skipNextListAnimation ? null : await animateListTransition(chordstabsList, direction);
                chordstabsList.innerHTML = '';
                chordstabsList.style.counterReset = `list-counter ${startIdx}`;

                pageItems.forEach(p => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-800/70 backdrop-blur rounded-2xl p-4 md:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white/10 flex items-center song-list-item';
                    listItem.innerHTML = `
                        <a href="${p.url}" target="_blank" rel="noopener noreferrer" class="flex items-center w-full">
                            <span class="text-xl text-white font-semibold flex-1">
                                ${p.title} - <span class="text-gray-400 font-normal">${p.artist}</span>
                            </span>
                        </a>
                    `;
                    chordstabsList.appendChild(listItem);
                });
                if (enterClass) {
                    chordstabsList.classList.add(enterClass);
                    requestAnimationFrame(() => {
                        chordstabsList.classList.remove(enterClass);
                    });
                }
                skipNextListAnimation = false;

                if (chordstabsPagination) chordstabsPagination.classList.remove('hidden');
                buildPagination(total, chordstabsPage, (p) => { chordstabsPage = p; renderChordstabs(textContent); }, chordstabsPagination);
            }

            function renderCurrentTab(textContent) {
                if (currentTab === 'all') {
                    const p = renderAllSongs(textContent);
                    if (allSection) {
                        allSection.classList.remove('fade-in');
                        void allSection.offsetWidth;
                        allSection.classList.add('fade-in');
                    }
                    return p;
                }
                const p = renderChordstabs(textContent);
                if (chordstabsSection) {
                    chordstabsSection.classList.remove('fade-in');
                    void chordstabsSection.offsetWidth;
                    chordstabsSection.classList.add('fade-in');
                }
                return p;
            }

            async function updateUI(lang) {
                const textContent = translations[lang] || translations['ru'];

                try { localStorage.setItem('lang', lang); } catch (e) {}

                document.getElementById('pageTitle').textContent = textContent.pageTitle;
                document.getElementById('mainTitle').textContent = textContent.mainTitle;
                document.getElementById('mainDescription').textContent = textContent.mainDescription;

                lastTextContent = textContent;

                if (tabAll) tabAll.textContent = textContent.tabAll;
                if (tabChordstabsBtn) tabChordstabsBtn.textContent = textContent.tabChordstabs;
                if (chordstabsHeaderEl) {
                    const chordstabsHeaderText = document.getElementById('chordstabsHeaderText');
                    if (chordstabsHeaderText) chordstabsHeaderText.textContent = textContent.chordstabsHeader + ' ';
                }

                if (searchInput) {
                    searchInput.placeholder = textContent.searchPlaceholder;
                    searchInput.setAttribute('aria-label', textContent.searchPlaceholder);
                    searchInput.value = searchQuery;
                    if (clearSearchBtn) {
                        clearSearchBtn.classList.toggle('hidden', !searchQuery);
                        clearSearchBtn.setAttribute('title', lang === 'en' ? 'Clear' : (lang === 'uk' ? 'Очистити' : 'Очистить'));
                    }
                }

                setActiveLangButton(lang);
                setActiveTab(currentTab);
            }

            function setActiveLangButton(lang) {
                ['ru','uk','en'].forEach(code => {
                    const btn = document.getElementById('lang-' + code);
                    if (!btn) return;
                    if (code === lang) {
                        btn.classList.add('active-lang','ring-2','ring-red-500');
                    } else {
                        btn.classList.remove('active-lang','ring-2','ring-red-500');
                    }
                });
            }

            // by apostrof_guitarist
            const langToggle = document.getElementById('lang-toggle');
            const langMenu = document.getElementById('langMenu');

            function openMenu() {
                if (!langMenu) return;
                langMenu.classList.add('open');
                langToggle?.setAttribute('aria-expanded','true');
            }
            function closeMenu() {
                if (!langMenu) return;
                langMenu.classList.remove('open');
                langToggle?.setAttribute('aria-expanded','false');
            }
            function toggleMenu() {
                if (!langMenu) return;
                if (langMenu.classList.contains('open')) closeMenu(); else openMenu();
            }

            langToggle?.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMenu();
            });

            document.getElementById('lang-ru').addEventListener('click', () => { updateUI('ru'); closeMenu(); });
            document.getElementById('lang-uk').addEventListener('click', () => { updateUI('uk'); closeMenu(); });
            document.getElementById('lang-en').addEventListener('click', () => { updateUI('en'); closeMenu(); });

            document.addEventListener('click', (e) => {
                if (!langMenu) return;
                if (!langMenu.contains(e.target) && e.target !== langToggle) {
                    closeMenu();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeMenu();
            });

            tabAll?.addEventListener('click', () => { setActiveTab('all'); });
            tabChordstabsBtn?.addEventListener('click', () => { setActiveTab('chordstabs'); });

            function commitSearch(value) {
                searchQuery = value;
                try { localStorage.setItem('searchQuery', searchQuery); } catch (e) {}
                if (searchQuery) {
                    songsPage = 1;
                    chordstabsPage = 1;
                }
                if (clearSearchBtn) clearSearchBtn.classList.toggle('hidden', !searchQuery);
                if (lastTextContent) renderCurrentTab(lastTextContent);
            }

            searchInput?.addEventListener('input', (e) => {
                commitSearch(e.target.value);
            });
            searchInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    commitSearch('');
                    if (searchInput) searchInput.value = '';
                }
            });
            clearSearchBtn?.addEventListener('click', () => {
                commitSearch('');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
            });

            function initIndicator() {
                if (!tabIndicator || !tabsContainer) return;
                const activeBtn = currentTab === 'all' ? tabAll : tabChordstabsBtn;
                if (activeBtn) {
                    const rect = activeBtn.getBoundingClientRect();
                    tabIndicator.style.width = `${rect.width}px`;
                    tabIndicator.style.height = `${rect.height}px`;
                }
                moveIndicatorTo(currentTab === 'all' ? tabAll : tabChordstabsBtn);
            }

            window.addEventListener('resize', () => {
                moveIndicatorTo(currentTab === 'all' ? tabAll : tabChordstabsBtn);
            });

            const savedLang = (() => { try { return localStorage.getItem('lang'); } catch(e) { return null; } })();

            const prefs = (Array.isArray(navigator.languages) && navigator.languages.length ? navigator.languages : [navigator.language]).filter(Boolean);

            function normalizeLang(code) {
                const base = String(code || '').toLowerCase().split('-')[0];
                if (base === 'ua') return 'uk';
                return base;
            }

            const initialLang = translations[savedLang] ? savedLang : (() => {
                for (const p of prefs) {
                    const c = normalizeLang(p);
                    if (translations[c]) return c;
                }
                return 'en';
            })();

            updateUI(initialLang);
            if (currentTab !== 'all' && currentTab !== 'chordstabs') {
                currentTab = 'all';
            }
            // by apostrof_guitarist
            requestAnimationFrame(initIndicator);

            const particlesCanvas = document.getElementById('bgParticles');
            if (particlesCanvas && particlesCanvas.getContext) {
                const ctx = particlesCanvas.getContext('2d');
                let canvasWidth = 0;
                let canvasHeight = 0;
                let devicePixelRatioSafe = Math.max(1, (window.devicePixelRatio || 1));
                let stageWidth = 0;
                let stageHeight = 0;

                function resizeCanvas() {
                    const prevStageWidth = stageWidth;
                    const prevStageHeight = stageHeight;
                    devicePixelRatioSafe = Math.max(1, (window.devicePixelRatio || 1));
                    const cssWidth = window.innerWidth;
                    const cssHeight = window.innerHeight;
                    canvasWidth = Math.floor(cssWidth * devicePixelRatioSafe);
                    canvasHeight = Math.floor(cssHeight * devicePixelRatioSafe);
                    particlesCanvas.width = canvasWidth;
                    particlesCanvas.height = canvasHeight;
                    particlesCanvas.style.width = cssWidth + 'px';
                    particlesCanvas.style.height = cssHeight + 'px';
                    stageWidth = cssWidth;
                    stageHeight = cssHeight;
                    ctx.setTransform(devicePixelRatioSafe, 0, 0, devicePixelRatioSafe, 0, 0);

                    if (prevStageWidth > 0 && prevStageHeight > 0) {
                        const scaleX = stageWidth / prevStageWidth;
                        const scaleY = stageHeight / prevStageHeight;
                        for (let i = 0; i < particles.length; i++) {
                            particles[i].x *= scaleX;
                            particles[i].y *= scaleY;
                        }
                    }
                }

                const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const targetCount = Math.min(140, Math.max(60, Math.floor((window.innerWidth * window.innerHeight) / 18000)));
                const particles = [];

                function random(min, max) { return Math.random() * (max - min) + min; }

                function createParticle() {
                    const size = random(1.0, 2.6);
                    const speed = random(0.08, 0.35) * (size / 2.6);
                    return {
                        x: random(0, stageWidth || window.innerWidth),
                        y: random(0, stageHeight || window.innerHeight),
                        vx: random(-0.05, 0.05),
                        vy: -speed,
                        size,
                        alpha: random(0.25, 0.75)
                    };
                }

                function seedParticles() {
                    particles.length = 0;
                    for (let i = 0; i < targetCount; i++) particles.push(createParticle());
                }

                function wrap(p) {
                    const margin = 24;
                    const w = stageWidth || window.innerWidth;
                    const h = stageHeight || window.innerHeight;
                    if (p.x < -margin) p.x = w + margin;
                    if (p.x > w + margin) p.x = -margin;
                    if (p.y < -margin) p.y = h + margin;
                    if (p.y > h + margin) p.y = -margin;
                }

                function drawFrame() {
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
                    ctx.restore();
                    for (let i = 0; i < particles.length; i++) {
                        const p = particles[i];
                        p.x += p.vx;
                        p.y += p.vy;
                        wrap(p);
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(230, 57, 70, ${p.alpha})`;
                        ctx.fill();
                    }
                }

                let running = !document.hidden && !prefersReducedMotion;
                function tick() {
                    if (!running) return;
                    drawFrame();
                    requestAnimationFrame(tick);
                }

                window.addEventListener('resize', () => {
                    resizeCanvas();
                });
                document.addEventListener('visibilitychange', () => {
                    running = !document.hidden && !prefersReducedMotion;
                    if (running) requestAnimationFrame(tick);
                });

                resizeCanvas();
                seedParticles();
                if (!prefersReducedMotion) {
                    requestAnimationFrame(tick);
                } else {
                    drawFrame();
                }
            }
        });
    </script>
</body>
</html>
